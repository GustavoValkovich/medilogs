<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediLogs - Agregar Paciente</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #32495d 0%, #2b3f50 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .container-fluid {
            max-width: 1200px;
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .card-header {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            padding: 1.5rem;
        }

        .form-floating > label {
            color: #6c757d;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 500;
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .form-text {
            font-size: 0.875rem;
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
        }

        .excel-section {
            transition: all 0.4s ease;
            animation: slideDown 0.4s ease-out;
        }

        .excel-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.15);
        }

        .file-input-group {
            position: relative;
        }

        .file-input-group .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        .excel-closing {
            animation: slideUp 0.3s ease-in;
        }

        #toggleExcelBtn {
            transition: all 0.3s ease;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }

        #toggleExcelBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        #toggleIcon {
            transition: transform 0.3s ease;
        }

        .toggle-rotated {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h2 class="mb-0">
                            <i class="bi bi-person-plus me-2"></i>
                            Agregar Nuevo Paciente
                        </h2>
                    </div>
                    <div class="card-body p-4">
                        <!-- Alert para mensajes -->
                        <div id="alertContainer"></div>

                        <!-- Bot√≥n para mostrar/ocultar importaci√≥n Excel -->
                        <div class="text-center mb-4">
                            <button type="button" class="btn btn-outline-success btn-lg" id="toggleExcelBtn">
                                <i class="bi bi-file-earmark-excel me-2"></i>
                                Importar desde Excel
                                <i class="bi bi-chevron-down ms-2" id="toggleIcon"></i>
                            </button>
                        </div>

                        <!-- Secci√≥n de Importaci√≥n de Excel (oculta por defecto) -->
                        <div class="card mb-4 excel-section d-none" id="excelSection" style="border: 2px dashed #28a745; background: rgba(40, 167, 69, 0.05);">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="bi bi-file-earmark-excel me-2 text-success"></i>
                                    Importar Pacientes desde Excel
                                </h5>
                                <p class="text-muted mb-3">
                                    Puede cargar m√∫ltiples pacientes desde un archivo Excel. 
                                    <a href="#" id="downloadTemplateBtn" class="text-decoration-none">
                                        <i class="bi bi-download me-1"></i>Descargar plantilla
                                    </a>
                                </p>
                                
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="input-group file-input-group">
                                            <input type="file" class="form-control" id="excelFileInput" 
                                                   accept=".xlsx,.xls" aria-describedby="excelFileHelp">
                                            <button class="btn btn-outline-success" type="button" id="uploadExcelBtn">
                                                <i class="bi bi-upload me-2"></i>Cargar Excel
                                            </button>
                                        </div>
                                        <div id="excelFileHelp" class="form-text">
                                            Seleccione un archivo Excel (.xlsx, .xls) con los datos de pacientes
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div id="uploadProgress" class="d-none">
                                            <div class="spinner-border spinner-border-sm text-success me-2"></div>
                                            <span class="text-success">Procesando...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bot√≥n para cerrar la secci√≥n -->
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="closeExcelBtn">
                                        <i class="bi bi-x-circle me-1"></i>Cerrar importaci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Separador (visible solo cuando Excel est√° abierto) -->
                        <div class="text-center mb-4 d-none" id="separatorDiv">
                            <span class="text-muted fs-5">√≥</span>
                        </div>

                        <!-- Formulario individual de paciente -->
                        <h5 class="mb-3" id="formTitle">
                            <i class="bi bi-person-plus me-2"></i>
                            Agregar Paciente Individual
                        </h5>
                        <form id="patientForm">
                            <div class="row">
                                <!-- Nombre -->
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="nombre" placeholder="Nombre" required>
                                        <label for="nombre" class="required-field">
                                            <i class="bi bi-person me-2"></i>Nombre
                                        </label>
                                    </div>
                                </div>

                                <!-- Documento -->
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="documento" placeholder="Documento" required>
                                        <label for="documento" class="required-field">
                                            <i class="bi bi-card-text me-2"></i>Documento (DNI/CI)
                                        </label>
                                    </div>
                                    <div class="form-text">Ingrese el n√∫mero de documento sin puntos ni espacios</div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Fecha de Nacimiento -->
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="date" class="form-control" id="nacimiento" placeholder="Fecha de Nacimiento" required>
                                        <label for="nacimiento" class="required-field">
                                            <i class="bi bi-calendar me-2"></i>Fecha de Nacimiento
                                        </label>
                                    </div>
                                </div>

                                <!-- Sexo -->
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <select class="form-select" id="sexo">
                                            <option value="">Seleccionar...</option>
                                            <option value="M">Masculino</option>
                                            <option value="F">Femenino</option>
                                        </select>
                                        <label for="sexo">
                                            <i class="bi bi-gender-ambiguous me-2"></i>Sexo
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Email -->
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="email" class="form-control" id="mail" placeholder="Email">
                                        <label for="mail">
                                            <i class="bi bi-envelope me-2"></i>Email
                                        </label>
                                    </div>
                                    <div class="form-text">Email de contacto del paciente</div>
                                </div>

                                <!-- Localidad -->
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="localidad" placeholder="Localidad">
                                        <label for="localidad">
                                            <i class="bi bi-geo-alt me-2"></i>Localidad
                                        </label>
                                    </div>
                                    <div class="form-text">Ciudad o localidad de residencia (opcional)</div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Obra Social -->
                                <div class="col-md-12 mb-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="obra_social" placeholder="Obra Social">
                                        <label for="obra_social">
                                            <i class="bi bi-hospital me-2"></i>Obra Social
                                        </label>
                                    </div>
                                    <div class="form-text">Nombre de la obra social o prepaga</div>
                                </div>
                            </div>

                            <!-- Informaci√≥n Importante -->
                            <div class="mb-4">
                                <label for="importante" class="form-label">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Informaci√≥n Importante
                                </label>
                                <textarea class="form-control" id="importante" rows="4"></textarea> 
                                <div class="form-text">
                                    Informaci√≥n m√©dica relevante que debe tenerse siempre en cuenta
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="row">
                                <div class="col-12 text-center">
                                    <button type="button" class="btn btn-secondary me-3" id="cancelBtn">
                                        <i class="bi bi-x-circle me-2"></i>Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="saveBtn">
                                        <span class="spinner-border spinner-border-sm me-2 d-none" id="saveSpinner"></span>
                                        <span class="btn-text">
                                            <i class="bi bi-check-circle me-2"></i>Guardar Paciente
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuraci√≥n de la API
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // Variables globales
        let medicoId = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè• [PACIENTES] Pantalla de agregar paciente cargada');
            
            // Obtener el m√©dico ID del localStorage o sessionStorage
            medicoId = localStorage.getItem('medicoId') || sessionStorage.getItem('medicoId');
            
            if (!medicoId) {
                console.warn('‚ö†Ô∏è No se encontr√≥ ID de m√©dico, redirigiendo al login');
                showAlert('Sesi√≥n expirada. Por favor inicie sesi√≥n nuevamente.', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            console.log('üë®‚Äç‚öïÔ∏è [PACIENTES] M√©dico ID:', medicoId);
            
            // Event listeners
            document.getElementById('patientForm').addEventListener('submit', handleSavePatient);
            document.getElementById('cancelBtn').addEventListener('click', handleCancel);
            
            // Validaci√≥n en tiempo real del documento
            document.getElementById('documento').addEventListener('input', validateDocumento);
            
            // Event listeners para Excel
            document.getElementById('toggleExcelBtn').addEventListener('click', toggleExcelSection);
            document.getElementById('closeExcelBtn').addEventListener('click', closeExcelSection);
            document.getElementById('uploadExcelBtn').addEventListener('click', handleExcelUpload);
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
            document.getElementById('excelFileInput').addEventListener('change', handleFileSelection);
        });

        // Funci√≥n para mostrar alertas
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                    <i class="bi bi-${getAlertIcon(type)} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHTML;
            
            // Auto-hide despu√©s de 5 segundos
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        function getAlertIcon(type) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Validaci√≥n del documento
        function validateDocumento(event) {
            const input = event.target;
            let value = input.value.replace(/\D/g, ''); // Solo n√∫meros
            
            if (value.length > 8) {
                value = value.substring(0, 8); // M√°ximo 8 d√≠gitos
            }
            
            input.value = value;
        }

        // Funci√≥n para guardar paciente
        async function handleSavePatient(event) {
            event.preventDefault();
            
            console.log('üíæ [PACIENTES] Iniciando guardado de paciente...');
            
            // Obtener datos del formulario
            const formData = {
                medico_id: parseInt(medicoId),
                nombre: document.getElementById('nombre').value.trim(),
                documento: document.getElementById('documento').value.trim(),
                nacimiento: document.getElementById('nacimiento').value,
                localidad: document.getElementById('localidad').value.trim() || null,
                sexo: document.getElementById('sexo').value || null,
                mail: document.getElementById('mail').value.trim() || null,
                obra_social: document.getElementById('obra_social').value.trim() || null,
                importante: document.getElementById('importante').value.trim() || null
            };

            // Validaciones b√°sicas
            if (!formData.nombre) {
                showAlert('El nombre es obligatorio', 'danger');
                document.getElementById('nombre').focus();
                return;
            }

            if (!formData.documento) {
                showAlert('El documento es obligatorio', 'danger');
                document.getElementById('documento').focus();
                return;
            }

            if (formData.documento.length < 5) {
                showAlert('El documento debe tener al menos 5 d√≠gitos', 'danger');
                document.getElementById('documento').focus();
                return;
            }

            if (!formData.nacimiento) {
                showAlert('La fecha de nacimiento es obligatoria', 'danger');
                document.getElementById('nacimiento').focus();
                return;
            }

            // Validaci√≥n de email si se proporciona
            if (formData.mail && !isValidEmail(formData.mail)) {
                showAlert('El email no tiene un formato v√°lido', 'danger');
                document.getElementById('mail').focus();
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            const btnText = saveBtn.querySelector('.btn-text');
            const spinner = document.getElementById('saveSpinner');
            
            // Mostrar loading
            saveBtn.disabled = true;
            btnText.innerHTML = '<i class="bi bi-clock me-2"></i>Guardando...';
            spinner.classList.remove('d-none');
            
            try {
                console.log('üì§ [PACIENTES] Enviando datos:', formData);
                
                // Obtener token de autenticaci√≥n
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('Token no encontrado. Usuario no autenticado.');
                    window.location.href = 'login.html';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/patients`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log('üì• [PACIENTES] Respuesta del servidor:', result);

                if (result.success) {
                    showAlert('‚úÖ Paciente guardado exitosamente', 'success');
                    
                    // Limpiar formulario despu√©s de 1 segundo
                    setTimeout(() => {
                        document.getElementById('patientForm').reset();
                    }, 1000);
                    
                    // Redirigir al index despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'Error al guardar el paciente');
                }

            } catch (error) {
                console.error('‚ùå [PACIENTES] Error:', error);
                showAlert(`Error al guardar el paciente: ${error.message}`, 'danger');
            } finally {
                // Restaurar bot√≥n
                saveBtn.disabled = false;
                btnText.innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardar Paciente';
                spinner.classList.add('d-none');
            }
        }

        // Funci√≥n para validar email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Funci√≥n para cancelar
        function handleCancel() {
            if (confirm('¬øEst√° seguro que desea cancelar? Se perder√°n los datos ingresados.')) {
                window.location.href = 'index.html';
            }
        }

        // Manejar tecla Escape para cancelar
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                handleCancel();
            }
        });

        // ========== FUNCIONES PARA IMPORTACI√ìN DE EXCEL ==========

        // Mostrar/ocultar secci√≥n de Excel
        function toggleExcelSection() {
            const excelSection = document.getElementById('excelSection');
            const separatorDiv = document.getElementById('separatorDiv');
            const toggleBtn = document.getElementById('toggleExcelBtn');
            const formTitle = document.getElementById('formTitle');
            
            if (excelSection.classList.contains('d-none')) {
                // Mostrar secci√≥n
                excelSection.classList.remove('d-none');
                separatorDiv.classList.remove('d-none');
                
                // Cambiar bot√≥n
                toggleBtn.innerHTML = `
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    Ocultar importaci√≥n Excel
                    <i class="bi bi-chevron-up ms-2" id="toggleIcon"></i>
                `;
                toggleBtn.classList.remove('btn-outline-success');
                toggleBtn.classList.add('btn-success');
                
                // Cambiar t√≠tulo del formulario
                formTitle.innerHTML = `
                    <i class="bi bi-person-plus me-2"></i>
                    √≥ Agregar Paciente Individual
                `;
                formTitle.classList.add('text-muted');
                
                console.log('üìä [EXCEL] Secci√≥n de importaci√≥n abierta');
            } else {
                closeExcelSection();
            }
        }

        // Cerrar secci√≥n de Excel
        function closeExcelSection() {
            const excelSection = document.getElementById('excelSection');
            const separatorDiv = document.getElementById('separatorDiv');
            const toggleBtn = document.getElementById('toggleExcelBtn');
            const fileInput = document.getElementById('excelFileInput');
            const formTitle = document.getElementById('formTitle');
            
            // Agregar animaci√≥n de cierre
            excelSection.classList.add('excel-closing');
            
            setTimeout(() => {
                // Ocultar secci√≥n
                excelSection.classList.add('d-none');
                excelSection.classList.remove('excel-closing');
                separatorDiv.classList.add('d-none');
                
                // Resetear bot√≥n
                toggleBtn.innerHTML = `
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    Importar desde Excel
                    <i class="bi bi-chevron-down ms-2" id="toggleIcon"></i>
                `;
                toggleBtn.classList.remove('btn-success');
                toggleBtn.classList.add('btn-outline-success');
                
                // Resetear t√≠tulo del formulario
                formTitle.innerHTML = `
                    <i class="bi bi-person-plus me-2"></i>
                    Agregar Paciente Individual
                `;
                formTitle.classList.remove('text-muted');
                
                // Limpiar archivo seleccionado
                fileInput.value = '';
                handleFileSelection();
                
                console.log('üìä [EXCEL] Secci√≥n de importaci√≥n cerrada');
            }, 300);
        }

        // Manejar selecci√≥n de archivo
        function handleFileSelection() {
            const fileInput = document.getElementById('excelFileInput');
            const uploadBtn = document.getElementById('uploadExcelBtn');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                uploadBtn.innerHTML = `<i class="bi bi-upload me-2"></i>Importar ${file.name}`;
                uploadBtn.classList.remove('btn-outline-success');
                uploadBtn.classList.add('btn-success');
            } else {
                uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Cargar Excel';
                uploadBtn.classList.remove('btn-success');
                uploadBtn.classList.add('btn-outline-success');
            }
        }

        // Descargar plantilla de Excel
        async function downloadTemplate() {
            try {
                console.log('üì• [EXCEL] Descargando plantilla...');
                
                // Obtener token de autenticaci√≥n
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('Token no encontrado. Usuario no autenticado.');
                    window.location.href = 'login.html';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/files/excel/template/pacientes`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Descargar el archivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'template_pacientes.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAlert('‚úÖ Plantilla descargada exitosamente', 'success');
                
            } catch (error) {
                console.error('‚ùå [EXCEL] Error descargando plantilla:', error);
                showAlert(`Error al descargar la plantilla: ${error.message}`, 'danger');
            }
        }

        // Manejar importaci√≥n de Excel
        async function handleExcelUpload() {
            const fileInput = document.getElementById('excelFileInput');
            const uploadBtn = document.getElementById('uploadExcelBtn');
            const progressDiv = document.getElementById('uploadProgress');
            
            if (!fileInput.files.length) {
                showAlert('Por favor seleccione un archivo Excel para importar', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validar tipo de archivo
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showAlert('Por favor seleccione un archivo Excel v√°lido (.xlsx o .xls)', 'danger');
                return;
            }
            
            try {
                console.log('üì§ [EXCEL] Iniciando importaci√≥n:', file.name);
                
                // Mostrar progreso
                uploadBtn.disabled = true;
                progressDiv.classList.remove('d-none');
                
                // Crear FormData
                const formData = new FormData();
                formData.append('excel', file);
                formData.append('medico_id', medicoId);
                
                // Obtener token de autenticaci√≥n
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('Token no encontrado. Usuario no autenticado.');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Realizar upload
                const response = await fetch(`${API_BASE_URL}/files/excel/import/pacientes`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const { imported, errors, duplicates } = result.data;
                    
                    let message = `‚úÖ Importaci√≥n completada:<br>`;
                    message += `‚Ä¢ ${imported.length} pacientes importados correctamente<br>`;
                    
                    if (duplicates && duplicates.length > 0) {
                        message += `‚Ä¢ ${duplicates.length} pacientes ya exist√≠an (duplicados)<br>`;
                    }
                    
                    if (errors && errors.length > 0) {
                        message += `‚Ä¢ ${errors.length} errores encontrados<br>`;
                        console.warn('‚ö†Ô∏è [EXCEL] Errores de importaci√≥n:', errors);
                        
                        // Mostrar detalles de errores si son pocos
                        if (errors.length <= 3) {
                            message += '<br><strong>Errores:</strong><br>';
                            errors.forEach((error, index) => {
                                message += `${index + 1}. ${error}<br>`;
                            });
                        }
                    }
                    
                    showAlert(message, imported.length > 0 ? 'success' : 'warning');
                    
                    // Limpiar formulario si la importaci√≥n fue exitosa
                    if (imported.length > 0) {
                        fileInput.value = '';
                        handleFileSelection();
                        
                        // Cerrar secci√≥n de Excel despu√©s de un momento
                        setTimeout(() => {
                            closeExcelSection();
                        }, 2000);
                        
                        // Opcional: redirigir al index despu√©s de un tiempo
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 4000);
                    }
                    
                } else {
                    throw new Error(result.message || 'Error al importar el archivo');
                }
                
            } catch (error) {
                console.error('‚ùå [EXCEL] Error en importaci√≥n:', error);
                showAlert(`Error al importar el archivo: ${error.message}`, 'danger');
            } finally {
                // Restaurar estado
                uploadBtn.disabled = false;
                progressDiv.classList.add('d-none');
            }
        }
    </script>
</body>
</html>
